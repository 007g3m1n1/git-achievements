#!/bin/bash
#
# Copyright (c) 2010, Benjamin C. Meyer <ben@meyerhome.net>
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#    This product includes software developed by the <organization>.
# 4. Neither the name of the project nor the
#    names of its contributors may be used to endorse or promote products
#    derived from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER ''AS IS'' AND ANY
# EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE FOR ANY
# DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#

function git_achivements_command
{
    case $2 in
        -p )
            publish_achievements
            ;;
        -a )
            cat "${ACHIEVEMENTSLOGFILE}"
            ;;
        * )
            echo "Git Achievements"
            count=`cat "${ACHIEVEMENTSLOGFILE}" 2> /dev/null | grep Unlocked | wc -l`
            echo ""
            echo "You currently have: $count achievements"
            echo ""
            echo "Options:"
            echo "    -a show all achievements"
            echo "    -p publish existing achievements to github"
            ;;
    esac
}

function log_action
{
    echo "$@" >> "${ACTIONLOGFILE}"
    echo -n "Date: " >> "${ACTIONLOGFILE}"
    date >> ${ACTIONLOGFILE}
}

function output_achievement
{
echo "
********************************************************************************
Git Achievement Unlocked!

$1
$2
********************************************************************************
" |  sed  -e :a -e 's/^.\{1,79\}$/ & /;ta'
}

function unlock_achievement
{
    grep "$1" "${ACHIEVEMENTSLOGFILE}" > /dev/null
    if [ $? -eq 0 ] ; then
        return
    fi
    output_achievement "$@"
    output_achievement "$@" >> "${ACHIEVEMENTSLOGFILE}"

    if [ `git config --global achievement.upload` = "true" ] ; then
        publish_achievements $@
    fi
}

function count_command
{
    export powerof2=`awk "START {n=0} /$1/ {n++} END { print and(n, n-1) }" "$ACTIONLOGFILE"`
    export power=`awk "START {n=0} /$1/ {n++} END { print log(n)/log(2) }" "$ACTIONLOGFILE"`
    export count=`awk "START {n=0} /$1/ {n++} END { print n }" "$ACTIONLOGFILE"`
    if [ $count -eq 1 ] ; then
        powerof2="1"
    fi
    #echo "$1 $powerof2 $power $count"
}

function check_for_achievements
{
   case $1 in
        achievements )
            git_achivements_command "$@"
            ;;
        add )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Stone Mason (Level $power)" "Added files to the index area for inclusion in the next commit with git add."
            fi
            case $2 in
                *.gitignore )
                unlock_achievement "Caretaker" "Added a .gitignore file to a repository."
                ;;
                -p )
                count_command "add -p"
                if [ "${powerof2}" = "0" ] ; then
                    unlock_achievement "Miller (Level $power)" "Add only part of a file to the stage $count times."
                fi
                ;;
            esac
            ;;
        am )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Messenger (Level $power)" "Apply a patch using am $count times."
            fi
            ;;
        bisect )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Hunter (Level $power)" "Used git bisect $count times to perform a binary search to find which change introduced a bug."
            fi
            ;;
        blame )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Investigator (Level $power)" "Used git blame to annotates each line in a file with information about the revision which last modified the line."
            fi
            ;;
        cherry-pick )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Cherry Picker (Level $power)" "Used git cherry-pick to add a sha from another branch into the current branch."
            fi
            ;;
        checkout )
            case $2 in
                -b )
                count_command "checkout -b"
                if [ "${powerof2}" = "0" ] ; then
                    unlock_achievement "Blacksmith (Level $power)" "Created a branch using checkout -b."
                fi
                ;;
            esac
            ;;
        commit )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Wisdom (Level $power)" "Made $count commits using git commit."
            fi
            case $2 in
                --amend )
                count_command "commit --amend"
                if [ "${powerof2}" = "0" ] ; then
                    unlock_achievement "Seamstress (Level $power)" "$count amended commits with git commit --amend."
                fi
                ;;
                -s )
                count_command "commit -s"
                if [ "${powerof2}" = "0" ] ; then
                    unlock_achievement "Locksmith (Level $power)" "Add Signed-off-by line by the committer at the end of the commit log message using git commit -s."
                fi
                ;;
            esac
            ;;
        config )
            if [[ $# -ge 4 && $2 = "--global" && $3 = "user.name" ]] ; then
                unlock_achievement "Homeowner (name)" "Set global user name using git config."
            fi
            if [[ $# -ge 4 && $2 = "--global" && $3 = "user.email" ]] ; then
                unlock_achievement "Homeowner (address)" "Set global email address using git config."
            fi
            ;;
        diff )
            case $2 in
                --cached )
                count_command "diff --cached"
                if [ "${powerof2}" = "0" ] ; then
                    unlock_achievement "Goldsmith (Level $power)" "Reviewed patches before committing with git diff --cached."
                fi
                ;;
            esac

            ;;
        gc )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Chimney Sweeper" "Used git gc to run a number of housekeeping tasks on the current repository."
            fi
            ;;
        init )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Architect (Level $power)" "Created a new repository with git init."
            fi
            ;;
        log )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Historian (Level $power)" "Investigate the log $count times using git log."
            fi
            case $2 in
                -p* )
                unlock_achievement "Dentist" "Extracted patches using git log -p."
                ;;
                -S* )
                unlock_achievement "Librarian" "Looked for differences that introduce or remove an instance of a string with git log -S"
                ;;
            esac
            ;;
        push )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Socialite (Level $power)" "$count pushes to a remote repository using git push"
            fi
            ;;
        rebase )
            case $2 in
                -i )
                count_command "rebase -i"
                if [ "${powerof2}" = "0" ] ; then
                    unlock_achievement "Butcher (Level $power)" "Performed an interactive rebase using git rebase -i."
                fi
                ;;
            esac
            ;;
        reflog )
            unlock_achievement "Weaver" "Investigate old branches by using git reflog"
            ;;
        remote )
            case $2 in
                add )
                count_command "remote add"
                if [ "${powerof2}" = "0" ] ; then
                    unlock_achievement "Merchant (Level $power)" "Added an external repository with git remote add."
                fi
                ;;
            esac
            ;;
        svn|p4 )
            count_command "$@"
            if [ "${powerof2}" = "0" ] ; then
                unlock_achievement "Traveler (Level $power)" "$count dealings with another rcs such as svn or p4."
            fi
            ;;
    esac

    case $2 in
        --help )
            unlock_achievement "Student" "Accessed the documentation for a command with git [command] --help"
            ;;
    esac

    hooks=`ls .git/hooks/ | grep -v sample | wc -l`
    if [ $hooks -ge 1 ] ; then
        unlock_achievement "Master Carpenter (Level: $hooks)" "Custom installed hooks are present which help catch issues before they are shared."
    fi
}
function publish_achievements
{
    gh_pages=`which git-achievements`
    gh_pages=`dirname $gh_pages`
    cd $gh_pages

    user=`git config --global user.name`

echo "
<head>
<title>${user}'s Git Achievements</title>
<link rel=\"alternate\" type=\"application/rss+xml\" title\"rss feed\" href=\"index.rss\">
<style type=\"text/css\">
body {
    background-color: black;
    color: white;
    margin: 0 auto;
    width: 600px;
    text-align: center;
}
li {
    background-color: #1E2024;
    border: 1px solid gray;
    padding: .25em;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    margin-bottom: .5em;
}
div.title {
    font-weight: bold;
}
ul {
    text-align: left;
    list-style-type:none;
}
#locked {
    visibility: hidden;
}
</style>
</head>
<body>
" > index.html

    echo "<h2>${user}'s Git Achievements</h2>" >> index.html

    total=`cat "${ACHIEVEMENTSLOGFILE}" | grep Unlocked | wc -l`
    echo "<center>${total} <a href=\"http://github.com/icefox/git-achievements\">Git Achievements</a> unlocked</center><br>" >> index.html

    echo "<ul>" >> index.html
    cat "${ACHIEVEMENTSLOGFILE}" | grep -v '^$' | grep -v 'Git Achievement Unlocked!' | grep -v '*' | sed -e 's/^ *//g'  -e 's/ *$//g' | awk '{ if (NR % 2 != 0) printf "<li>  <div class=\"title\">" $0 "</div>"; else printf "  <div class=\"info\">" $0 "</div></li>\n" }' | tac >> index.html

    echo "</ul>" >> index.html

    # List locked achievements
    cat git-achievements  | grep 'unlock_achievement ' | grep -v sed | sed -e 's/ *unlock_achievement //g' -e 's/^"//g' -e 's/"$//g' -e 's/\$power/X/g' -e 's/\$count/X/g' | sort | awk -F"\" \"" '{ print "<li><div class=\"title\">" $1 "</div><div class=\"info\">" $2 "</div></li>" }' > all.html

    total=`cat all.html  | wc -l`
    echo "<script type=\"text/javascript\">
function showLocked() {
    document.getElementById('locked').style.visibility = 'visible';
    document.getElementById('showlocked').style.visibility = 'hidden';
}
</script>
<a id=\"showlocked\" href=\"javascript:showLocked()\" >Show locked Achievements</a>
<div id=\"locked\">
There are $total Achievements in total and achievements that have X can can be leveled depending on their usage (1, 2, 4, 16, 32, etc)
<ul>" >> index.html

    cat all.html  | while read line ;
    do
        stripedline=`echo $line | sed -e 's/<\/div>.*//g' -e s/\(.*//g`
        grep "$stripedline" index.html > /dev/null
        if [ ! $? -eq 0 ] ; then
            echo $line >> index.html
        fi
    done
    echo '</ul></div>' >> index.html
    rm all.html

    echo "</body></html>" >> index.html

    # Update the RSS feed
    echo '<?xml version="1.0" encoding="utf-8"?><rss version="2.0"><channel>' > index.rss
    echo "<title>${user}'s Git Achievements</title>" >> index.rss
    cat "${ACHIEVEMENTSLOGFILE}"  | grep -v '^$' | grep -v 'Git Achievement Unlocked!' | grep -v '*' | sed -e 's/^ *//g'  -e 's/ *$//g' | awk '{ if (NR % 2 != 0) printf "<item><title>" $0 "</title>"; else printf "<description>" $0 "</description></item>\n" }' | tac | head -n 20 >> index.rss
    echo '</channel></rss>' >> index.rss

    abortcount=`git status | grep 'Changes to be committed' | wc -l`
    if [ ! $abortcount -eq 0 ] ; then
        return
    fi

    git add index.html index.rss
    if [ -z $1 ] ; then
        message="Publishing updated achievement"
    else
        message="New achievement $1"
    fi
    git commit -m "${message}"
    git push origin gh-pages
}

if [ ! $1 = "achievements" ] ; then
    git "$@"
fi

ACTIONLOGFILE="$HOME/.git-achievements-action.log"
ACHIEVEMENTSLOGFILE="$HOME/.git-achievements.log"

log_action $@
check_for_achievements $@

